# SportYugra

Учебный дипломный проект.
Мобильное приложение на Flutter с интерактивной картой для поиска, фильтрации и просмотра спортивных объектов в Ханты-Мансийске с использованием SDK от Яндекс.Карт (yandex_maps_mapkit).
<img src="https://github.com/user-attachments/assets/6c9e260c-069f-4694-be92-2b6fdd734c42" alt="Screenshot_204" width="30%"/>
<img src="https://github.com/user-attachments/assets/ba578adc-68d7-4227-b7f4-02494ed5c90a" alt="Screenshot_203" width="30%"/>
<img src="https://github.com/user-attachments/assets/299afd0c-d5ac-497d-b053-505405db275f" alt="Screenshot_205" width="30%"/>
<img src="https://github.com/user-attachments/assets/c1624de6-ce23-4ea3-8b7f-8062c90ea374" alt="Screenshot_206" width="30%"/>
<img src="https://github.com/user-attachments/assets/f8cf107f-8b37-4862-a912-5b758dd6e812" alt="Screenshot_207" width="30%"/>
<img src="https://github.com/user-attachments/assets/5c1045b8-c422-4943-badf-0cd69f0f9803" alt="Screenshot_208" width="30%"/>
<img src="https://github.com/user-attachments/assets/bbec77f8-75af-4999-8ed0-840e840d3de6" alt="Screenshot_209" width="30%"/>

## Структура проекта

### Основные директории

- `lib/` - исходный код приложения
  - `camera/` - управление камерой карты
  - `config/` - конфигурация приложения и переменные окружения
  - `data/` - модели данных и источники данных
    - `placemarks/` - данные о метках на карте
    - `tags/` - модели и сервисы для работы с тегами
    - `tag_changes/` - модели и сервисы для отслеживания изменений тегов
  - `listeners/` - слушатели событий карты
  - `map_objects/` - управление объектами на карте (плейсмарки и их стили)
  - `permissions/` - управление разрешениями
  - `scenes/` - экраны приложения
    - `history_section.dart` - раздел истории изменений тегов
    - `about_app_section.dart` - раздел "О приложении"
    - `support_section.dart` - раздел "Поддержка"
  - `widgets/` - общие виджеты
    - `object_details_sheet.dart` - модальное окно с детальной информацией об объекте
- `assets/` - статические ресурсы
  - `images/` - изображения и иконки
  - `map_style.json` - стиль карты

### Ключевые файлы

- `lib/main.dart` - точка входа в приложение
- `lib/scenes/map_screen.dart` - главный экран с картой
- `lib/scenes/search_screen.dart` - экран поиска и отображения иерархии тегов
- `lib/scenes/history_section.dart` - раздел истории изменений тегов
- `lib/scenes/about_app_section.dart` - раздел с информацией о приложении
- `lib/scenes/support_section.dart` - раздел для связи с разработчиками
- `lib/config/env_config.dart` - загрузка переменных окружения
- `lib/data/placemarks/placemark_model.dart` - модель данных для меток
- `lib/data/placemarks/firestore_placemarks.dart` - сервис для работы с Firestore
- `lib/data/tags/tag_model.dart` - модель данных для тегов
- `lib/data/tags/firestore_tags.dart` - сервис для работы с тегами в Firestore
- `lib/data/tag_changes/tag_change_model.dart` - модель данных для изменений тегов
- `lib/data/tag_changes/firestore_tag_changes.dart` - сервис для работы с историей изменений
- `lib/map_objects/map_objects_manager.dart` - менеджер объектов карты, логика отображения и анимации
- `lib/listeners/map_object_tap_listener.dart` - обработчик нажатий на объекты карты
- `lib/widgets/object_details_sheet.dart` - виджет детальной информации об объекте

## Основные компоненты

### Карта (MapScreen)

Основной экран приложения, отображающий интерактивную Яндекс карту и спортивные объекты из БД в виде кастомных меток.

**Функциональность:**
- Отображение карты с пользовательскими метками
- Управление масштабом (кнопки зума)
- Определение местоположения пользователя
- Взаимодействие с метками (нажатие)
- **Загрузка данных из Firestore:** Объекты автоматически загружаются с сервера при открытии экрана и при нажатии кнопки обновления.
- **Анимация появления меток:** Новые метки появляются на карте с плавной анимацией масштабирования и эффектом отскока.
- **Отображение названий объектов:** Каждая метка сопровождается текстовой подписью с названием спортивного объекта.
- **Динамическая видимость названий объектов:** Названия объектов автоматически скрываются при отдалении карты (ниже определенного порога зума) и снова отображаются при приближении для улучшения читаемости и производительности.
- **Расчет расстояния до объектов:** Приложение автоматически рассчитывает расстояние от текущего местоположения пользователя до каждого объекта и отображает эту информацию в деталях объекта.
- **Реализован поиск с анимированным переходом на экран SearchScreen:** При нажатии на поисковую строку происходит плавный переход на экран поиска с Hero-анимацией.
- **Оптимизированная загрузка объектов:** Сначала загружаются базовые данные (координаты и названия) для быстрого отображения, затем в фоне загружаются дополнительные данные (теги, фото и т.д.).
- **Фильтрация объектов по тегам:** Возможность фильтровать объекты на карте по выбранным тегам с кнопкой сброса фильтров.
- **Доступ к дополнительным разделам:** Через нижнюю навигационную панель доступны разделы "Фильтры", "Поддержка", "История" и "О приложении".

### Раздел истории изменений (HistorySection)

Отображает историю изменений тегов для спортивных объектов.

**Функциональность:**
- **Отображение хронологии изменений:** Показывает, какие теги были добавлены или удалены для каждого объекта в порядке от новых к старым.
- **Информация о модерации:** Отображает email модератора, внесшего изменения, и точную дату/время изменения.
- **Визуализация изменений:** Добавленные теги отображаются зеленым цветом, а удаленные - красным.
- **Постраничная загрузка (пагинация):** Изначально загружается только 10 последних записей для быстрой загрузки.
- **Кнопка "Загрузить еще":** Позволяет подгрузить дополнительные записи истории (еще 10 записей за раз).
- **Умная пагинация:** Кнопка "Загрузить еще" отображается только при наличии дополнительных записей в базе данных.
- **Обновление данных:** Кнопка обновления для получения самых актуальных данных.
- **Обработка различных состояний:** Отображение индикатора загрузки, обработка ошибок и пустого состояния.

**Технические особенности:**
- Использует Firestore для хранения и загрузки истории изменений
- Применяет механизм пагинации с помощью метода `startAfterDocument`
- Оптимизирует загрузку данных путем загрузки дополнительной информации в одном запросе
- Обрабатывает различные состояния (загрузка, ошибка, пустое состояние)
- Использует кастомные UI-компоненты для отображения чипов тегов

### Раздел поддержки (SupportSection)

Новый раздел для обратной связи и поддержки пользователей.
Поддерживает два вида связи: **email** и **Telegram**.
Контактная информация для переадресации находится в **.env**

**Технические особенности:**
- Использует `url_launcher` для открытия внешних приложений (почтовый клиент, Telegram)
- Загружает контактные данные из переменных окружения с помощью `EnvConfig`
- Обрабатывает ошибки при невозможности открытия ссылок
- Поддерживает запуск внешних приложений в режиме `LaunchMode.externalApplication`

### Раздел "О приложении" (AboutAppSection)

Обновленный раздел с подробной информацией о приложении.

**Функциональность:**
- **Информация о версии:** Отображает текущую версию приложения.
- **Описание функций:** Подробное описание всех возможностей приложения.
- **Разделы с иконками:** Визуально привлекательное представление функций с соответствующими иконками.
- **Информация о разработчиках:** Данные о команде разработки и правообладателях.

**Технические особенности:**
- Использует прокручиваемый интерфейс для размещения большого объема информации
- Структурирован с помощью визуальных разделителей
- Применяет единый стиль для всех разделов информации
- Поддерживает динамическое обновление содержимого

### Управление переменными окружения (EnvConfig, flutter_dotenv)

Компонент для загрузки и управления переменными окружения.

- Автоматическая загрузка переменных окружения при запуске приложения.
- Хранение чувствительной информации вне кода приложения.
- Централизованный доступ к переменным окружения через статические методы.

## Основные компоненты

### Страница детальной информации об объекте (ObjectDetailsSheet)

Виджет `ObjectDetailsSheet` (`lib/widgets/object_details_sheet.dart`) представляет детальную информацию о спортивном объекте в виде модального окна, которое появляется при нажатии на метку на карте.

**Основные компоненты:**
- **Фотогалерея**: 
  - Слайдер фотографий объекта с индикатором страниц
  - Возможность открытия полноэкранного просмотра фотографий с жестами
  - Предзагрузка изображений для более плавного просмотра
  - Индикатор загрузки и обработка ошибок загрузки изображений
  - Заглушка при отсутствии фотографий

- **Информационные разделы**:
  - Название и краткое описание объекта
  - Система вкладок для удобной навигации (Описание, Теги)
  - Адрес с возможностью построения маршрута (интеграция с Яндекс.Картами, 2ГИС, Google Maps)
  - Контактная информация (телефон) с возможностью совершения звонка
  - Отображение расстояния до объекта от текущего местоположения пользователя
  - Список тегов для быстрого понимания категории объекта

- **Оптимизация памяти**:
  - Управление жизненным циклом загрузки изображений
  - Отмена загрузки изображений при закрытии страницы для освобождения ресурсов
  - Корректная обработка потери контекста при асинхронных операциях

**Технические особенности:**
- Виджет реализован с использованием `DraggableScrollableSheet` для удобного взаимодействия
- Поддерживает разные размеры экрана благодаря адаптивному дизайну
- Кешированная загрузка изображений для производительности
- Обработка различных форматов данных (например, телефонных номеров)

### Функциональность расчета расстояния

В приложении реализован механизм автоматического расчета расстояния от текущего местоположения пользователя до каждого спортивного объекта.

**Технические детали реализации:**
- Расчет расстояния происходит по формуле гаверсинусов, учитывающей кривизну земли
- Для определения местоположения пользователя используются несколько источников:
  1. Данные от `LocationManager` через `CameraManager` (основной источник)
  2. Данные от `UserLocationView` через слушатель `UserLocationObjectListener`
  3. В качестве запасного варианта используется текущее положение камеры

- Расстояние обновляется в следующих случаях:
  1. При первоначальной загрузке объектов на карту
  2. При нажатии на конкретный объект
  3. При обновлении местоположения пользователя
  4. При обновлении данных из Firestore

- Для хранения расстояний используется эффективная структура данных `HashMap<String, double>`, где ключ - уникальный идентификатор объекта

### Менеджер объектов карты (MapObjectsManager)

Класс `MapObjectsManager` (`lib/map_objects/map_objects_manager.dart`) отвечает за добавление, удаление и управление отображением объектов (меток) на карте. Он обрабатывает логику анимации и стилизации меток, включая настройку текстовых подписей.

### Модель данных меток (PlacemarkData)

Представляет информацию о спортивном объекте для отображения на карте.

**Поля:**
- `name` - название объекта
- `description` - описание объекта
- `location` - координаты (Point с latitude и longitude)
- `photoUrls` - список URL фотографий (опционально)
- `tags` - список тегов для категоризации (опционально)

### Обработчики событий

- `MapObjectTapListener` - обработка нажатий на объекты карты
- `UserLocationObjectListener` - обработка событий местоположения пользователя

### SearchScreen и система фильтрации

#### Экран поиска и фильтрации (SearchScreen)
- Экран поиска с текстовым полем и иерархией тегов
- Плавный переход с помощью Hero-анимации
- Автоматически активирует клавиатуру после завершения анимации перехода
- Поддерживает выбор тегов для фильтрации объектов на карте
- Отображает иерархию тегов с визуальным оформлением:
  - Цветовой градиент от красного (#fc4c4c) к белому для обозначения уровней вложенности
  - Анимированное появление блока иерархии

#### Система тегов и фильтрации
- **Эффективная работа с иерархией:** Использование childrenTags из модели TagData для корректного отображения структуры
- **Отладочные инструменты:** Логирование иерархии тегов для выявления проблем
- **Применение фильтров:** Выбранные теги передаются на экран карты и применяются для фильтрации объектов
- **Кнопка сброса фильтров:** На экране карты появляется кнопка для быстрого сброса всех фильтров

### Система тегов

Приложение поддерживает иерархическую систему тегов для категоризации спортивных объектов.

**Структура данных тегов:**
- Каждый тег имеет:
  - Уникальный идентификатор
  - Название на русском языке
  - Ссылку на родительский тег (или null для корневых тегов)
  - Список ссылок на дочерние теги

**Иерархия тегов:**
- Теги организованы в древовидную структуру с неограниченной вложенностью
- Корневые теги представляют основные категории (например, "тренажерный зал")
- Дочерние теги представляют подкатегории (например, "свободный вес", "гантели")
- Самые глубокие уровни могут содержать конкретные характеристики (например, "вес гантелей: 1-5 кг")

**Функциональность:**
- Загрузка всех тегов из Firestore и построение иерархии
- Загрузка тегов для конкретного спортивного объекта
- Проверка целостности иерархии тегов (обнаружение битых ссылок)
- Отображение иерархии тегов в виде дерева на экране поиска
- Отображение тегов объекта в виде чипов на странице объекта
- Фильтрация объектов на карте по выбранным тегам

**Технические детали:**
- Класс `TagData` представляет модель тега
- Класс `FirestoreTags` отвечает за загрузку и управление тегами
- Теги хранятся в коллекции `tags` в Firestore
- Спортивные объекты ссылаются на теги через массив ссылок `tags`

## Оптимизация производительности

### Двухэтапная загрузка данных
- **Быстрая начальная загрузка:** Сначала загружаются только базовые данные объектов (координаты и названия) для быстрого отображения на карте
- **Фоновая загрузка деталей:** Дополнительная информация (теги, фотографии, описания) загружается в фоновом режиме
- **Обновление фильтров:** После загрузки полной информации автоматически применяются активные фильтры

### Эффективное управление памятью
- **Изменяемые поля модели:** Поля в PlacemarkData сделаны изменяемыми для обновления данных без создания новых объектов
- **Оптимизация логов:** Удалены избыточные логи для улучшения производительности
- **Кэширование тегов:** Предварительная загрузка всех тегов для быстрого доступа

## Интеграция с Firebase

Приложение использует Firebase Cloud Firestore для хранения данных о спортивных объектах.

**Структура базы данных:**
- Коллекция `sportobjects` - содержит документы с информацией о спортивных объектах
  - Каждый документ содержит поля: 
    - `name` - название объекта
    - `description` - описание объекта
    - `location` (GeoPoint) - координаты
    - `photo-urls` - список URL фотографий
    - `tags` - список ссылок на документы в коллекции tags
    - `address` - адрес объекта (опционально)
    - `phone` - контактный телефон (опционально)

- Коллекция `tags` - содержит документы с информацией о тегах
  - Каждый документ содержит поля:
    - `name` - название тега на русском языке
    - `parent` - ссылка на родительский тег (DocumentReference или null)
    - `children` - список ссылок на дочерние теги (массив DocumentReference)

## Дополнительные ресурсы

- `mapkit-samples/` - официальные примеры использования Yandex MapKit (для справки)

## Последние обновления

### 8. Добавление разделов "Лента" и "Поддержка"
- **Новая функция:** Добавлены два новых раздела в приложение, доступные через нижнюю навигационную панель.
- **Раздел "История":**
  - Отображает хронологию изменений тегов для спортивных объектов
  - Показывает когда и какие изменения внесли в типы оборудования
  - Визуально различает добавленные (зеленые) и удаленные (красные) теги
  - Реализована пагинация для оптимизации загрузки большого количества записей
  - Загружает первоначально 10 записей с возможностью подгрузки дополнительных
  - Кнопка "Загрузить еще" появляется только при наличии дополнительных записей
- **Раздел "Поддержка":**
  - Предоставляет возможность связи с разработчиками через Email и Telegram
  - Использует безопасное хранение контактных данных в .env файле
  - Автоматически формирует тему письма при использовании Email
  - Реализует переход в чат Telegram с разработчиком
- **Технические улучшения:**
  - Создан класс `EnvConfig` для централизованного управления переменными окружения
  - Обновлен раздел "О приложении" с информацией о новых функциях
  - Добавлена модель данных `TagChangeData` для отслеживания изменений тегов
  - Реализован сервис `FirestoreTagChanges` для работы с историей изменений в Firestore
  - Оптимизирована загрузка дополнительных данных для истории изменений

### Оптимизация загрузки объектов на карту
- **Двухэтапная загрузка данных:** Реализован механизм поэтапной загрузки данных - сначала базовая информация (координаты, названия), затем в фоновом режиме подгружаются дополнительные детали (адреса, телефоны, фотографии, теги)
- **Улучшение UX:** Карта с основными метками отображается быстрее, пользователь может начать взаимодействие, не дожидаясь загрузки всех деталей
- **Фоновая загрузка:** Метод `_loadDetailedInfoInBackground` обеспечивает загрузку подробной информации без блокировки UI
- **Автоматическое применение фильтров:** После завершения загрузки деталей, активные фильтры применяются автоматически через вызов `refreshWithFilters()`

### Синглтон для FirestoreTags
- **Оптимизация кэширования:** Реализован паттерн Singleton для класса `FirestoreTags`, обеспечивающий единый экземпляр и общий кэш тегов для всего приложения
- **Эффективное использование памяти:** Исключено дублирование загрузки одних и тех же тегов в разных компонентах
- **API для управления кэшем:** Добавлен метод `clearCache()` для возможности очистки кэша при тестировании

### Исправления загрузки фотографий
- **Оптимизация доступа к данным:** Унифицирован подход к получению фотографий из Firestore через поле `photo-urls`
- **Корректная обработка отсутствия фотографий:** Отсутствие фотографий у объекта обрабатывается как нормальная ситуация без ошибок
- **Упрощение кода:** Удалены избыточные проверки различных вариантов названия полей с фотографиями
- **Улучшение логирования:** Добавлены информативные логи с количеством загруженных фотографий

### Корректное отображение детальной информации об объектах
- **Проверка полноты данных:** Перед отображением деталей объекта проверяется наличие всей необходимой информации
- **Загрузка по требованию:** Если какие-то детали (адрес, телефон, фото, теги) отсутствуют, они загружаются перед отображением модального окна
- **Метод `_loadPlacemarkDetails`:** Реализована функция для загрузки недостающих данных конкретного объекта из Firestore

### Обучающее окно для новых пользователей
Добавлено обучающее окно, которое появляется при первом запуске приложения после загрузки объектов на карту.
- **Содержание:** 
  - Краткие инструкции о том, как пользоваться приложением
  - Основные функции: просмотр деталей объектов, поиск и фильтрация
- **Техническая реализация:**
  - `shared_preferences` для отслеживания первого запуска приложения
  - Метод `_checkIfFirstLaunch()` определяет, нужно ли показывать обучающее окно
  - Метод `_showTutorialBottomSheet()` отображает модальное окно с инструкциями

### Индикатор загрузки деталей объекта
Заменен способ отображения процесса загрузки деталей объекта при нажатии на плейсмарк.
- **Интерфейс:**
  - Реализован полупрозрачный тёмный оверлей, закрывающий всю карту для фокусировки внимания пользователя
  - По центру экрана отображается жёлтый/красный индикатор загрузки (CircularProgressIndicator)
- **Техническая реализация:**
  - Улучшено кеширование данных об объектах для минимизации повторных загрузок
  - Добавлена проверка наличия данных в кеше перед загрузкой из Firestore
  - Оптимизирована последовательность загрузки и отображения данных

## Технические детали

- В классе `MapObjectsManager` добавлен метод `getPlacemarks()`, который возвращает копию списка всех плейсмарков.
- В методе `_clearAllFilters()` класса `_MapScreenState` добавлено обновление флага `_hasActiveFilters` для правильного отображения/скрытия кнопки очистки фильтров.
- Реализована "плавающая" кнопка "Применить" на экране поиска, которая всегда видна пользователю, даже при открытой клавиатуре.
- Оптимизирована задержка фокуса на поле поиска для более отзывчивого UX.
- Добавлен метод `_buildDiversityIndicator()` для расчета и отображения индикатора разнообразия оборудования
