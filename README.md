# SportYugra

Мобильное приложение для поиска и просмотра спортивных объектов в Ханты-Мансийске с использованием SDK от Яндекс.Карт.

## Структура проекта

### Основные директории

- `lib/` - исходный код приложения
  - `camera/` - управление камерой карты
  - `data/` - модели данных и источники данных
    - `placemarks/` - данные о метках на карте
  - `listeners/` - слушатели событий карты
  - `map_objects/` - управление объектами на карте (плейсмарки и их стили)
  - `permissions/` - управление разрешениями
  - `scenes/` - экраны приложения
  - `widgets/` - общие виджеты
    - `object_details_sheet.dart` - модальное окно с детальной информацией об объекте
- `assets/` - статические ресурсы
  - `images/` - изображения и иконки
  - `map_style.json` - стиль карты

### Ключевые файлы

- `lib/main.dart` - точка входа в приложение
- `lib/scenes/map_screen.dart` - главный экран с картой
- `lib/data/placemarks/placemark_model.dart` - модель данных для меток
- `lib/data/placemarks/firestore_placemarks.dart` - сервис для работы с Firestore
- `lib/map_objects/map_objects_manager.dart` - менеджер объектов карты, логика отображения и анимации
- `lib/listeners/map_object_tap_listener.dart` - обработчик нажатий на объекты карты
- `lib/widgets/object_details_sheet.dart` - виджет детальной информации об объекте

## Основные компоненты

### Карта (MapScreen)

Основной экран приложения, отображающий Яндекс карту и спортивные объекты в виде меток.

**Функциональность:**
- Отображение карты с пользовательскими метками
- Управление масштабом (кнопки зума)
- Определение местоположения пользователя
- Взаимодействие с метками (нажатие)
- **Загрузка данных из Firestore:** Объекты автоматически загружаются с сервера при открытии экрана и при нажатии кнопки обновления.
- **Анимация появления меток:** Новые метки появляются на карте с плавной анимацией масштабирования и эффектом отскока.
- **Отображение названий объектов:** Каждая метка сопровождается текстовой подписью с названием спортивного объекта.
- **Динамическая видимость названий объектов:** Названия объектов автоматически скрываются при отдалении карты (ниже определенного порога зума) и снова отображаются при приближении для улучшения читаемости и производительности.
- **Расчет расстояния до объектов:** Приложение автоматически рассчитывает расстояние от текущего местоположения пользователя до каждого объекта и отображает эту информацию в деталях объекта.

### Страница детальной информации об объекте (ObjectDetailsSheet)

Виджет `ObjectDetailsSheet` (`lib/widgets/object_details_sheet.dart`) представляет детальную информацию о спортивном объекте в виде модального окна, которое появляется при нажатии на метку на карте.

**Основные компоненты:**
- **Фотогалерея**: 
  - Слайдер фотографий объекта с индикатором страниц
  - Возможность открытия полноэкранного просмотра фотографий с жестами
  - Предзагрузка изображений для более плавного просмотра
  - Индикатор загрузки и обработка ошибок загрузки изображений
  - Заглушка при отсутствии фотографий

- **Информационные разделы**:
  - Название и краткое описание объекта
  - Система вкладок для удобной навигации (Описание, Теги)
  - Адрес с возможностью построения маршрута (интеграция с Яндекс Картами, 2ГИС, Google Maps)
  - Контактная информация (телефон) с возможностью совершения звонка
  - Отображение расстояния до объекта от текущего местоположения пользователя
  - Список тегов для быстрого понимания категории объекта

- **Оптимизация памяти**:
  - Управление жизненным циклом загрузки изображений
  - Отмена загрузки изображений при закрытии страницы для освобождения ресурсов
  - Корректная обработка потери контекста при асинхронных операциях

**Технические особенности:**
- Виджет реализован с использованием `DraggableScrollableSheet` для удобного взаимодействия
- Поддерживает разные размеры экрана благодаря адаптивному дизайну
- Кешированная загрузка изображений для производительности
- Обработка различных форматов данных (например, телефонных номеров)

### Функциональность расчета расстояния

В приложении реализован механизм автоматического расчета расстояния от текущего местоположения пользователя до каждого спортивного объекта.

**Технические детали реализации:**
- Расчет расстояния происходит по формуле гаверсинусов, учитывающей кривизну земли
- Для определения местоположения пользователя используются несколько источников:
  1. Данные от `LocationManager` через `CameraManager` (основной источник)
  2. Данные от `UserLocationView` через слушатель `UserLocationObjectListener`
  3. В качестве запасного варианта используется текущее положение камеры

- Расстояние обновляется в следующих случаях:
  1. При первоначальной загрузке объектов на карту
  2. При нажатии на конкретный объект
  3. При обновлении местоположения пользователя
  4. При обновлении данных из Firestore

- Для хранения расстояний используется эффективная структура данных `HashMap<String, double>`, где ключ - уникальный идентификатор объекта

- Отображение расстояния адаптивно:
  - Менее 1 км: отображается в метрах (например, "750 м")
  - Более 1 км: отображается в километрах с одним знаком после запятой (например, "2.5 км")

### Менеджер объектов карты (MapObjectsManager)

Класс `MapObjectsManager` (`lib/map_objects/map_objects_manager.dart`) отвечает за добавление, удаление и управление отображением объектов (меток) на карте. Он обрабатывает логику анимации и стилизации меток, включая настройку текстовых подписей.

### Модель данных меток (PlacemarkData)

Представляет информацию о спортивном объекте для отображения на карте.

**Поля:**
- `name` - название объекта
- `description` - описание объекта
- `location` - координаты (Point с latitude и longitude)
- `photoUrls` - список URL фотографий (опционально)
- `tags` - список тегов для категоризации (опционально)

### Обработчики событий

- `MapObjectTapListener` - обработка нажатий на объекты карты
- `UserLocationObjectListener` - обработка событий местоположения пользователя

## Интеграция с Firebase

Приложение использует Firebase Cloud Firestore для хранения данных о спортивных объектах.

**Структура базы данных:**
- Коллекция `sportobjects` - содержит документы с информацией о спортивных объектах
  - Каждый документ содержит поля: 
    - `name` - название объекта
    - `description` - описание объекта
    - `location` (GeoPoint) - координаты
    - `photoUrls` - список URL фотографий
    - `tags` - список тегов для категоризации
    - `address` - адрес объекта (опционально)
    - `phone` - контактный телефон (опционально)

## Дополнительные ресурсы

- `mapkit-samples/` - официальные примеры использования Yandex MapKit (для справки)